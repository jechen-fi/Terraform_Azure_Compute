
resource "azurerm_virtual_machine_extension" "iaasantimalware" {
  for_each = var.extension_name == "IaaSAntimalware" ? toset(["enabled"]) : toset([])

  name = "IaaSAntimalware"

  virtual_machine_id         = var.virtual_machine_id
  publisher                  = try(var.extension.publisher, "Microsoft.Azure.Security")
  type                       = try(var.extension.type, "IaaSAntimalware")
  type_handler_version       = try(var.extension.type_handler_version, "1.1")
  auto_upgrade_minor_version = try(var.extension.auto_upgrade_minor_version, true)
  tags                       = local.tags

  lifecycle {
    ignore_changes = [
      tags
    ]
  }

  settings = jsonencode(
    {
      "AntimalwareEnabled" : var.settings.AntimalwareEnabled,
      "RealtimeProtectionEnabled" : var.settings.RealtimeProtectionEnabled,
      "ScheduledScanSettings" : {
        "isEnabled" : var.settings.ScheduledScanSettings.isEnabled,
        "day" : var.settings.ScheduledScanSettings.day,
        "time" : var.settings.ScheduledScanSettings.time,
        "scanType" : var.settings.ScheduledScanSettings.scanType,
      },
      "Exclusions" : {
        "Extensions" : "",
        "Paths" : "",
        "Processes" : ""
      }
      "workspaceId" : var.settings.workspace_id
    }
  )

}
